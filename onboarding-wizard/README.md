# Onboarding Wizard

A React + TypeScript onboarding experience that walks Fullbay customers through AutoCare (ACES/PIES) data validation, vehicle clean-up, and export packaging. The app shells a lightweight Express API that orchestrates the `transformer/` pipeline, hydrates unit/parts matches from the generated output, and persists review decisions in a per-customer workspace.

## Prerequisites

- Node.js 18+
- Access to the mono-repo output tree (`../output`) generated by running the transformer.
- (Optional) Credentials needed by `transformer` when `npm run gen` executes locally.

## Getting Started

```bash
cd onboarding-wizard
npm install
npm run dev
```

- Vite serves the client on <http://localhost:3005>
- The API listens on <http://localhost:4005> and proxies via `/api` during `vite` dev.
- `npm run build` emits the client bundle and compiles the server into `dist/server`.

### Environment Controls

| Variable | Purpose |
| --- | --- |
| `PORT` | Override the API port (default `4005`). |
| `SKIP_TRANSFORMER_EXPORT` | When `true`, the server refuses to run `npm run gen`; the requested dataset must already exist under `../output`. |

## Data Flow & Persistence

1. **Bootstrap** (`POST /api/onboarding/bootstrap`): ensures `transformer` output exists for the provided customer ID (running `npm run gen -- --entityId <ID>` if the dataset is missing), loads vehicle/unit and part matching summaries, then seeds an onboarding session under `customer-output/<ID>/`.
2. **Vehicle Review** (`GET/POST /api/onboarding/:id/vehicles`): streams ACES match confidence, accepts VIN/make/model/year corrections, and lets users flag legacy units. Updated state is saved back to `review-state.json` for resumability.
3. **Parts Review** (`GET/POST /api/onboarding/:id/parts`): surfaces PIES matches and captures overrides or legacy status for difficult parts.
4. **Completion** (`POST /api/onboarding/:id/complete`): 
   - Creates `output/<ID>/user-validated/` directory with reviewed data
   - Applies all review changes to a copy of the original data
   - Adds `_reviewMetadata` to each record
   - Marks legacy items with `_legacy: true` flag
   - Copies the raw export into `customer-output/<ID>/raw-output/`
   - Writes `vehicles-reviewed.json`, `parts-reviewed.json`, and a `summary.json`

### User-Validated Export

When review is completed, the system generates a **user-validated** data export at `output/<entityId>/user-validated/`:

- **Original data preserved**: `output/<entityId>/` remains unchanged
- **Review changes applied**: All user modifications are in `user-validated/` directory
- **Metadata added**: Each record gets `_reviewMetadata` with status, match rate, notes
- **Legacy flagged**: Items marked as legacy have `_legacy: true` and `_legacyReason`

See [USER_VALIDATED_EXPORT.md](./USER_VALIDATED_EXPORT.md) for detailed documentation.

## Front-End Structure

- `src/pages/*Page.tsx` – step views (intake, vehicles, parts, summary).
- `src/state/wizardStore.ts` – zustand store for session state.
- `src/services/onboardingApi.ts` – typed client for `/api/onboarding` endpoints.
- `components/WizardLayout.tsx` – shared layout + progress indicator.

## Next Steps

- Wire auth/SSO guards before exposing the wizard externally.
- Layer a queue / background worker for long-running transformer runs instead of blocking the API request.
- Enrich match analytics (confidence sparkline, unmatched clustering) and attach inline quick actions for bulk updates.
